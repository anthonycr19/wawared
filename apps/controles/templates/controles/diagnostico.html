{% extends 'dashboard/base.html' %}
{% load static %}
{% load form_controls_tags %}
{% block title %}Diagnóstico{% endblock %}
{% block extra_style %}
    <link rel="stylesheet" href="{% static 'css/datepicker.css' %}"/>
    <link rel="stylesheet" href="{% static 'css/select2.css' %}"/>
    <link rel="stylesheet" href="{% static 'css/nv.d3.min.css' %}"/>
    <style>
        #antecedentes-obstetricos-div {
            height: 300px;
        }
        #chart-altura-uterina {
            height: 450px;
        }
        #chart-ganancia-peso-materno {
            height: 450px;
        }
    </style>
{% endblock %}
{% block container %}
<div class="row">
    <div class="col-md-12">
        <div id="data">
            <form class="form-horizontal" id="form-diagnostico" name="form-diagnostico" role="form" method="post">
                {% csrf_token %}
                <div class="panel panel-default">
                    <div id="data-head" class="panel-heading">
                        <h3 class="panel-title">Diagnósticos del Atención prenatal</h3>
                    </div>
                    {% include 'embarazos/partials/paciente_resume_header.html' with paciente=paciente %}
                    <div class="panel-body">
                        <div class="panel-body">
                            <div id="data-gestante" class="panel panel-default">
                                <div class="panel-heading">
                                    Resumen
                                </div>
                                {% include 'controles/partials/control_nav.html' with control=control %}
                                <input type="hidden" name="next_url" id="next-url"/>

                                <div class="panel-body">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <h4>Sintomas</h4>
                                            <div class="panel panel-default" id="data-buscar-body">
                                                <table class="table table-striped table-bordered">
                                                    <thead>
                                                    <tr>
                                                        <th>Código</th>
                                                        <th>Nombre</th>
                                                        <th>Observación</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% for sintoma in control.sintomas.all %}
                                                    <tr>
                                                        <td>{{ sintoma.cie.codigo }}</td>
                                                        <td>
                                                            {% if sintoma.cie.nombre_mostrar %}{{ sintoma.cie.nombre_mostrar }}{% else %}{{ sintoma.cie.nombre }}{% endif %}
                                                        </td>
                                                        <td>{{ sintoma.observacion }}</td>
                                                    </tr>
                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    <h4>Laboratorio</h4>
                                    <div class="row">
                                        <div class="col-md-6">
                                        {% with control.laboratorio as lab %}
                                        {% if lab.rapida_sifilis != 'no se hizo' %}
                                            <p>
                                            Primera rápida sífilis: {{ lab.rapida_sifilis|upper }} {{ lab.rapida_sifilis_fecha|date:'d/m/Y' }} {{ lab.rapida_sifilis_observacion }}
                                            </p>
                                        {% endif %}
                                        {% if lab.rapida_vih_1 != 'no se hizo' %}
                                            <p>
                                            Primera prueba rapida VIH: {{ lab.rapida_vih_1|upper }} {{ lab.rapida_vih_1|date:'d/m/Y' }} {{ lab.rapida_vih_1_observacion }}
                                            </p>
                                        {% endif %}
                                        {% if lab.rapida_vih_2 != 'no aplica' %}
                                            <p>
                                            Segunda prueba rapida VIH: {{ lab.rapida_vih_2|upper }} {{ lab.rapida_vih_2|date:'d/m/Y' }} {{ lab.rapida_vih_2_observacion }}
                                            </p>
                                        {% endif %}
                                        {% if lab.grupo %}
                                            <p>Grupo: {{ lab.grupo }}</p>
                                        {% endif %}
                                        {% if lab.factor %}
                                            <p>Factor: {{ lab.factor }}</p>
                                        {% endif %}
                                        {% if lab.rapida_hemoglobina %}
                                            <p>Rápida Hemoglobina: {{ lab.rapida_hemoglobina_resultado|floatformat:'.2f' }} {{ lab.rapida_hemoglobina_fecha|date:'d/m/Y' }}</p>
                                        {% endif %}
                                        {% if lab.hemoglobina_1 %}
                                            <p>Hemoglobina 1: {{ lab.hemoglobina_1_resultado|floatformat:'.2f' }} {{ lab.hemoglobina_1_resultado|date:'d/m/Y' }}</p>
                                        {% endif %}
                                        {% if lab.hemoglobina_2 %}
                                            <p>Hemoglobina 2: {{ lab.hemoglobina_2_resultado|floatformat:'.2f' }} {{ lab.hemoglobina_2_fecha|date:'d/m/Y' }}</p>
                                        {% endif %}
                                        {% if lab.hemoglobina_alta %}
                                            <p>Hemoglobina Alta: {{ lab.hemoglobina_alta_resultado|floatformat:'.2f' }} {{ lab.hemoglobina_alta_fecha|date:'d/m/Y' }}</p>
                                        {% endif %}
                                        {% if lab.glicemia_1 != 'no se hizo' %}
                                            <p>Glicemia 1: {{ lab.glicemia_1|upper }} {{ lab.glicemia_1_fecha|date:'d/m/Y' }} {{ lab.glicemia_1_observacion }}</p>
                                        {% endif %}
                                        {% if lab.glicemia_2 != 'no se hizo' %}
                                            <p>Glicemia 2: {{ lab.glicemia_2|upper }} {{ lab.glicemia_2_fecha|date:'d/m/Y' }} {{ lab.glicemia_2_observacion }}</p>
                                        {% endif %}
                                        {% if lab.examen_completo_orina_1 != 'no se hizo' %}
                                            <p>Examen completo de orina 1: {{ lab.examen_completo_orina_1|upper }} {{ lab.examen_completo_orina_1_fecha|date:'d/m/Y' }} {{ lab.examen_completo_orina_1_observacion }}</p>
                                        {% endif %}
                                        {% if lab.examen_completo_orina_2 != 'no se hizo' %}
                                            <p>Examen completo de orina 2: {{ lab.examen_completo_orina_2|upper }} {{ lab.examen_completo_orina_2_fecha|date:'d/m/Y' }} {{ lab.examen_completo_orina_2_observacion }}</p>
                                        {% endif %}
                                        {% if lab.leucocituria != 'no se hizo' %}
                                            <p>Leucocitura: {{ lab.leucocituria|upper }} {{ lab.leucocituria_fecha|date:'d/m/Y' }} {{ lab.leucocituria_observacion }}</p>
                                        {% endif %}
                                        {% if lab.nitritos != 'no se hizo' %}
                                            <p>Nitritos: {{ lab.nitritos|upper }} {{ lab.nitritos_fecha|date:'d/m/Y' }} {{ lab.nitritos_observacion }}</p>
                                        {% endif %}
                                        </div>
                                        <div class="col-md-6">
                                        {% if lab.vdrl_rp_1 != 'no se hizo' %}
                                            <p>VDRL 1: {{ lab.vdrl_rp_1|upper }} {{ lab.vdrl_rp_1_fecha|date:'d/m/Y' }} {{ lab.vdrl_rp_1_observacion }}</p>
                                        {% endif %}
                                        {% if lab.vdrl_rp_2 != 'no aplica' %}
                                            <p>VDRL 2: {{ lab.vdrl_rp_2|upper }} {{ lab.vdrl_rp_2_fecha|date:'d/m/Y' }} {{ lab.vdrl_rp_2_observacion }}</p>
                                        {% endif %}
                                        {% if lab.elisa != 'no aplica' %}
                                            <p>ELISA: {{ lab.elisa|upper }} {{ lab.elisa_fecha|date:'d/m/Y' }} {{ lab.elisa_observacion }}</p>
                                        {% endif %}
                                        {% if lab.pap != 'no se hizo' %}
                                            <p>PAP: {{ lab.pap|upper }} {{ lab.pap_fecha|date:'d/m/Y' }} {{ lab.pap_observacion }}</p>
                                        {% endif %}
                                        {% if lab.iva != 'no aplica' %}
                                            <p>IVA: {{ lab.iva|upper }} {{ lab.iva_fecha|date:'d/m/Y' }} {{ lab.iva_observacion }}</p>
                                        {% endif %}
                                        {% if lab.colposcopia != 'no aplica' %}
                                            <p>Colposcopia: {{ lab.colposcopia|upper }} {{ lab.colposcopia_fecha|date:'d/m/Y' }} {{ lab.colposcopia_observacion }}</p>
                                        {% endif %}
                                        {% if lab.ifi_western_blot != 'no aplica' %}
                                            <p>IFI/Western Blot: {{ lab.ifi_western_blot|upper }} {{ lab.ifi_western_blot_fecha|date:'d/m/Y' }} {{ lab.ifi_western_blot_observacion }}</p>
                                        {% endif %}
                                        {% if lab.torch != 'no aplica' %}
                                            <p>Torch: {{ lab.torch|upper }} {{ lab.torch_fecha|date:'d/m/Y' }} {{ lab.torch_observacion }}</p>
                                        {% endif %}
                                        {% if lab.gota_gruesa != 'no aplica' %}
                                            <p>Gota gruesa: {{ lab.gota_gruesa|upper }} {{ lab.gota_gruesa_fecha|date:'d/m/Y' }} {{ lab.gota_gruesa_observacion }}</p>
                                        {% endif %}
                                        {% if lab.malaria_prueba_rapida != 'no aplica' %}
                                            <p>Malaria Prueba Rapida: {{ lab.malaria_prueba_rapida|upper }} {{ lab.malaria_prueba_rapida_fecha|date:'d/m/Y' }} {{ lab.malaria_prueba_rapida_observacion }}</p>
                                        {% endif %}
                                        {% if lab.fluorencia_malaria != 'no aplica' %}
                                            <p>Fluorescencia Malaria: {{ lab.fluorencia_malaria|upper }} {{ lab.fluorencia_malaria_fecha|date:'d/m/Y' }} {{ lab.fluorencia_malaria_observacion }}</p>
                                        {% endif %}
                                        {% if lab.urocultivo != 'no aplica' %}
                                            <p>Urocultivo: {{ lab.urocultivo|upper }} {{ lab.urocultivo_fecha|date:'d/m/Y' }} {{ lab.urocultivo_observacion }}</p>
                                        {% endif %}
                                        {% if lab.bk_en_esputo != 'no aplica' %}
                                            <p>BK en esputo: {{ lab.bk_en_esputo|upper }} {{ lab.bk_en_esputo_fecha|date:'d/m/Y' }} {{ lab.bk_en_esputo_observacion }}</p>
                                        {% endif %}
                                        {% if lab.listeria != 'no aplica' %}
                                            <p>Listeria: {{ lab.listeria|upper }} {{ lab.listeria_fecha|date:'d/m/Y' }} {{ lab.listeria_observacion }}</p>
                                        {% endif %}
                                        {% if lab.tamizaje_hepatitis_b != 'no aplica' %}
                                            <p>Tamizaje hepatitis B: {{ lab.tamizaje_hepatitis_b|upper }} {{ lab.tamizaje_hepatitis_b_fecha|date:'d/m/Y' }} {{ lab.tamizaje_hepatitis_b_observacion }}</p>
                                        {% endif %}
                                        {% if lab.tolerancia_glucosa != 'no aplica' %}
                                            <p>Tolerancia Glucosa: {{ lab.tolerancia_glucosa|upper }} {{ lab.tolerancia_glucosa_fecha|date:'d/m/Y' }} {{ lab.tolerancia_glucosa_observacion }}</p>
                                        {% endif %}
                                        {% if lab.fta_abs != 'no aplica' %}
                                            <p>FTA Abs: {{ lab.fta_abs|upper }} {{ lab.fta_abs_fecha|date:'d/m/Y' }} {{ lab.fta_abs_observacion }}</p>
                                        {% endif %}
                                        {% if lab.tpha != 'no aplica' %}
                                            <p>THPA: {{ lab.tpha|upper }} {{ lab.tpha_fecha|date:'d/m/Y' }} {{ lab.tpha_observacion }}</p>
                                        {% endif %}
                                        {% endwith %}
                                        </div>
                                    </div>
                                    {% if control.examen_fisico.es_conservado %}
                                        <h4>Examen Físico conservado</h4>
                                    {% else %}
                                    <div class="row">
                                        {% with control.examen_fisico as ef %}
                                        <div class="col-md-6">
                                            <h4>Examen Físico</h4>
                                            <h5>Hallazgo patológico</h5>
                                            <ol>
                                                {% for examen in ef.resume.patologicos %}
                                                <li>{{ examen.nombre }} {% if examen.observacion %}: {{ examen.observacion }}{% endif %}</li>
                                                {% endfor %}
                                            </ol>
                                            <p>Nivel de conciencia: {{ ef.print_nivel_conciencia }}</p>
                                            {% if ef.especuloscopia %}
                                                Especuloscopia: {{ ef.especuloscopia }}<br/>
                                            {% endif %}
                                            <p>Escala de bishop: {{ ef.tv_tb_resultado }}</p>
                                            <hr/>
                                            {% if ef.tv_cambio_cervicales != None %}
                                                Cambios Cervicales: {% if ef.tv_cambio_cervicales %}Si{% else %}No{% endif %} <br/>
                                            {% endif %}
                                            {% if ef.tv_hallazgos %}
                                                Hallazgos: {{ ef.tv_hallazgos }}<br/>
                                            {% endif %}
                                            {% if ef.tv_incorporacion %}
                                                Incorporación: {{ ef.tv_incorporacion }}<br/>
                                            {% endif %}
                                            {% if ef.tv_liquido_anmiotico %}
                                                Liquido anmiotico: {{ ef.tv_liquido_anmiotico }}<br/>
                                            {% endif %}
                                            {% if ef.tv_membranas %}
                                                Membranas: {{ ef.tv_membranas }}<br/>
                                            {% endif %}
                                            {% if ef.tv_otros %}
                                                Otros: {{ ef.tv_otros }}<br/>
                                            {% endif %}
                                            <hr/>
                                            {% if ef.pelvimetria %}
                                                Pelvimetria: {{ ef.print_pelvimetria }}<br/>
                                            {% endif %}
                                            <h5>Examen Ginecológico</h5>
                                            <ol>
                                                {% for examen in ef.resume.ginecologicos %}
                                                <li>{{ examen.nombre }}: {{ examen.valor }}</li>
                                                {% endfor %}
                                                {% if ef.eg_vulvas %}
                                                <li>Vulvas: {{ ef.eg_vulvas }}</li>
                                                {% endif %}
                                                {% if ef.eg_genitales_externos %}
                                                <li>Genitales externos: {{ ef.eg_genitales_externos }}</li>
                                                {% endif %}
                                                {% if ef.eg_vagina %}
                                                <li>Vagina: {{ ef.eg_vagina }}</li>
                                                {% endif %}
                                            </ol>
                                        </div>
                                        {% endwith %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div id="data-gestante" class="panel panel-default">
                            <div class="panel-heading">
                                Buscar diagnosticos
                            </div>
                            <div class="panel-body">
                                <input id="input-search" type="text" name="q" autofocus style="width: 100%">
                                <!--<form role="search" method="get" action="">
                                </form>-->
                            </div>
                            <div class="panel-body">
                                <h4>Seleccionados</h4>
                                <div class="panel panel-default" id="data-buscar-body">
                                    <table class="table table-striped table-bordered">
                                        <thead>
                                        <tr>
                                            <th></th>
                                            <th>Diagnostico</th>
                                            <th>CIE 10</th>
                                            <th>D</th>
                                            <th>P</th>
                                            <th>R</th>
                                            <th>LAB</th>
                                            <th>Observación</th>
                                            <th>Eliminar</th>
                                        </tr>
                                        </thead>
                                        <tbody id="tbody-seleccionados">
                                        {% for detalle in detalles %}
                                        <tr data-order="{{ detalle.order }}" {% ifequal detalle.cie.codigo ficha_puntaje_cie %}class="danger"{% endifequal %}>
                                            <td>
                                                <input type="checkbox" class="checkbox-cie" data-cie="{{ detalle.cie.codigo }}" checked/>
                                            </td>
                                            <td class="col-md-4">{{ detalle.cie.nombre_display|title }}</td>
                                            <td>{{ detalle.cie.codigo }}</td>
                                            <td>
                                                <label>
                                                    <input type="radio" name="radio-detalle-{{ detalle.cie.codigo|replace:". -" }}" {% ifequal detalle.tipo 'D' %}checked{% endifequal %} value="D"/>
                                                </label>
                                            </td>
                                            <td>
                                                <label>
                                                    <input type="radio" name="radio-detalle-{{ detalle.cie.codigo|replace:". -" }}" {% ifequal detalle.tipo 'P' %}checked{% endifequal %} value="P"/>
                                                </label>
                                            </td>
                                            <td>
                                                <label>
                                                    <input type="radio" name="radio-detalle-{{ detalle.cie.codigo|replace:". -" }}" {% ifequal detalle.tipo 'R' %}checked{% endifequal %} value="R"/>
                                                </label>
                                            </td>
                                            <td>
                                                <input type="text" class="form-control laboratorio" value="{{ detalle.laboratorio }}"/>
                                            </td>
                                            <td>
                                                <textarea class="form-control observacion" rows="1">{{ detalle.observacion }}</textarea>
                                            </td>
                                            <td>
                                                <input type="checkbox" class="checkbox-delete"/>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                <h4>Sugeridos</h4>
                                <div class="panel panel-default" id="data-buscar-body">
                                    <table class="table table-striped table-bordered">
                                        <thead>
                                        <tr>
                                            <th></th>
                                            <th>Diagnostico</th>
                                            <th>CIE 10</th>
                                            <th>D</th>
                                            <th>P</th>
                                            <th>R</th>
                                            <th>LAB</th>
                                            <th>Observación</th>
                                            <th>Eliminar</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        {% for cie in cies %}
                                        <tr {% ifequal cie.codigo ficha_puntaje_cie %}class="danger{% endifequal %}">
                                            <td>
                                                <input type="checkbox" class="checkbox-cie for-select" data-cie="{{ cie.codigo }}"/>
                                            </td>
                                            <td class="col-md-4">{{ cie.nombre_display|title }}</td>
                                            <td>{{ cie.codigo }}</td>
                                            <td>
                <label>
                <input type='radio' name='radio-detalle-{{ cie.codigo|replace:". -" }}' value='D'/>
                </label>
                                            </td>
                                            <td>
                <label>
                <input type="radio" name="radio-detalle-{{ cie.codigo|replace:". -" }}" value="P"/>
                </label>
                                            </td>
                                            <td>
                <label>
                <input type="radio" name="radio-detalle-{{ cie.codigo|replace:". -" }}" value="R"/>
                </label>
                                            </td>
                                            <td>
                                                <input type="text" class="form-control laboratorio"/>
                                            </td>
                                            <td>
                                                <textarea class="form-control observacion" rows="1"></textarea>
                                            </td>
                                            <td>
                                                <input type="checkbox" class="checkbox-delete"/>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="panel-body">
                                <div class="row">
                                    <div class="col-md-5">
                                        {% include 'dashboard/partials/form_group_textarea.html' with field=form.plan_trabajo %}
                                        {% include 'dashboard/partials/form_group_textarea.html' with field=form.tratamiento %}
                                        {% include 'dashboard/partials/form_group_textarea.html' with field=form.tratamiento_2 %}
                                        {% include 'dashboard/partials/form_group_date.html' with field=form.proxima_cita %}
                                    </div>
                                    <div class="col-md-5">
                                        Laboratorio: Examenes a pedir
                                        {% include 'dashboard/partials/checkbox.html' with field=form.examen_hemoglobina %}
                                        {% include 'dashboard/partials/checkbox.html' with field=form.examen_hemograma %}
                                        {% include 'dashboard/partials/checkbox.html' with field=form.examen_orina %}
                                        {% include 'dashboard/partials/checkbox.html' with field=form.examen_glucosa %}
                                        {% include 'dashboard/partials/checkbox.html' with field=form.examen_grupo_sanguineo %}
                                        {% include 'dashboard/partials/checkbox.html' with field=form.examen_factor %}
                                        <div class="form-group">
                                            <label for="{{ form.otros_examenes.auto_id }}" class="col-sm-3 control-label">{{ form.otros_examenes.label }}</label>
                                            <div class="col-sm-9">
                                                {{ form.otros_examenes }}
                                                {% for error in form.otros_examenes.errors %}
                                                <div class="alert alert-danger">{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="panel panel-default" id="data-buscar-body">
                                    <div class="row">
                                        <div class="col-sm-10">
                                            <table class="table table-stripped table-bordered">
                                                <thead>
                                                <tr>
                                                    <th></th>
                                                    <th class="fum {% if form.instance.control.eg_elegida == 'fum' %}success{% endif %}">Fecha última menstruación</th>
                                                    <th class="ecografia {% if form.instance.control.eg_elegida == 'ecografia' %}success{% endif %}">Ecografía</th>
                                                    <th class="altura-uterina {% if form.instance.control.eg_elegida == 'altura uterina' %}success{% endif %}">Altura uterina</th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                <tr>
                                                    <td>Edad gestacional actual</td>
                                                    <td class="fum {% if form.instance.control.eg_elegida == 'fum' %}success{% endif %}">{{ form.instance.control.eg_fum }}</td>
                                                    <td class="ecografia {% if form.instance.control.eg_elegida == 'ecografia' %}success{% endif %}">{{ form.instance.control.eg_ecografia }}</td>
                                                    <td class="altura-uterina {% if form.instance.control.eg_elegida == 'altura uterina' %}success{% endif %}">{{ form.instance.control.eg_altura_uterina }}</td>
                                                </tr>
                                                <tr>
                                                    <td>Fecha probable de parto</td>
                                                    <td class="fum {% if form.instance.control.eg_elegida == 'fum' %}success{% endif %}">{{ form.instance.control.fecha_probable_parto_fum|date:'d/m/Y' }}</td>
                                                    <td class="ecografia {% if form.instance.control.eg_elegida == 'ecografia' %}success{% endif %}">{{ form.instance.control.fecha_probable_parto_ecografia|date:'d/m/Y' }}</td>
                                                    <td class="altura-uterina {% if form.instance.control.eg_elegida == 'altura uterina' %}success{% endif %}">{{ form.instance.control.fecha_probable_parto_altura_uterina|date:'d/m/Y' }}</td>
                                                </tr>
                                                <tr>
                                                    <td>Edad gestacional elegida</td>
                                                    <td colspan="3">
                                                        {% include 'dashboard/partials/form_group_input.html' with field=form.eg_elegida %}
                                                        <div class="btn-group">
                                                            <button id="js-btn-eg-fum" class="btn btn-default" type="button" {% if not control.embarazo.fum %}disabled {% endif %}>FUM</button>
                                                            <button id="js-btn-eg-eco" class="btn btn-default" type="button" {% if not control.embarazo.primera_ecografia %}disabled{% endif %}>Ecografía</button>
                                                            <button id="js-btn-eg-au" class="btn btn-default" type="button">Altura Uterina</button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="panel-body">
                                <div class="row">
                                    <div class="col-sm-6">
                                        <h2 class="text-center">Ganancia peso materno IMC: {{ control.imc_clasificacion|upper }}</h2>
                                        <div id="chart-ganancia-peso-materno">
                                            <svg></svg>
                                        </div>
                                    </div>
                                    <div class="col-sm-6">
                                        <h2 class="text-center">Altura uterina materna</h2>
                                        <div id="chart-altura-uterina">
                                            <svg></svg>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Inicio de agregar procedimiento -->
                        <div id="data-gestante" class="panel panel-default">
                            <div class="panel-heading">
                                Buscar Procedimientos
                            </div>
                            <div class="panel-body">
                                <input id="input-search-cpt" type="text" name="q" autofocus style="width: 100%">
                                <!--<form role="search" method="get" action="">
                                </form>-->
                            </div>
                            <div class="panel-body">
                                <h4>Seleccionados</h4>
                                <div class="panel panel-default" id="data-buscar-body">
                                    <table class="table table-striped table-bordered">
                                        <thead>
                                        <tr>
                                            <th></th>
                                            <th>Procedimineto</th>
                                            <th>CPT</th>
                                            <th>Observación</th>
                                            <th>Eliminar</th>
                                        </tr>
                                        </thead>
                                        <tbody id="tbody-seleccionados-cpt">
                                        {% for procedimiento in procedimientos %}
                                        <tr data-order="{{ procedimiento.order }}">
                                            <td>
                                                <input type="checkbox" class="checkbox-cpt" data-cpt="{{ procedimiento.cpt.codigo_cpt }}" checked/>
                                            </td>
                                            <td class="col-md-4">{{ procedimiento.cpt.nombre_display|title }}</td>
                                            <td>{{ procedimiento.cpt.codigo_cpt }}</td>
                                            <td>
                                                <textarea class="form-control observacion" rows="1">{{ procedimiento.observacion }}</textarea>
                                            </td>
                                            <td>
                                                <input type="checkbox" class="checkbox-delete"/>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <!-- Fin de agregar procedimiento -->
                        <div class="panel-body">
                            <div class="panel panel-default" id="data-buscar-body">
                                <div class="panel-heading">
                                    Antecedentes Familiares
                                </div>
                                {% include 'pacientes/partials/antecedentes_familiares_resume_table.html' with paciente=paciente %}
                            </div>
                        </div>
                        <div class="panel-body">
                            <div class="panel panel-default" id="data-buscar-body">
                                <div class="panel-heading">
                                    Antecedentes Médicos - Personales
                                </div>
                                {% include 'pacientes/partials/antecedentes_medicos_resume_table.html' with paciente=paciente %}
                            </div>
                        </div>
                        <div class="panel-body">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    Antecedentes Obstetricos
                                </div>
                                <div class="panel-body">
                                    <div class="row">
                                        <div class="col-md-12" id="antecedentes-obstetricos-div"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="panel-footer">
                        <div class="pull-left">
                            {% if 'controles.change_diagnostico' in user.get_all_permissions %}
                            <a class="btn btn-default" href="{% url 'controles:edit' control.id %}">Regresar al control</a>
                            {% else %}
                            <a class="btn btn-default" href="{% url 'controles:detail' control.id %}">Regresar al control</a>
                            {% endif %}
                        </div>
                        <div class="text-right">
                            <input class="btn btn-green" type="button" value="Guardar" id="btn-save"/>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
{% block bottom_scripts %}
    <script src="{% static 'js/vendor/raphael.min.js' %}"></script>
    <script src="{% static 'js/antecedentes_obstetricos_graphic.js' %}"></script>
    <script src="{% static 'js/bootstrap-datepicker.js' %}"></script>
    <script src="{% static 'js/vendor/select2.min.js' %}"></script>
    <script src="{% static 'js/vendor/d3.min.js' %}"></script>
    <script src="{% static 'js/vendor/nv.d3.min.js' %}"></script>
    <script src="{% static 'js/vendor/jquery-ui.min.js' %}"></script>
    <script type="text/javascript">

        $(document).ready(function(){

            var addObserverChangeCheckbox = function(){

                $.each($("input[type='checkbox'].checkbox-cie"),function(index,elem){
                    $(elem).on("click",function(){
                        var tr = $(this).parent().parent();
                        tr.find("input[type='checkbox'].checkbox-delete").remove();

                        if(this.checked){
                            $dom = $("<input type='checkbox' class='checkbox-delete'/>");
                            $(this).parent().parent().find("td").eq(8).append($dom);
                        }else{
                            $dom = $("<input type='checkbox' class='checkbox-delete' checked />");
                            $(this).parent().parent().find("td").eq(8).append($dom);
                        }
                    });
                });

                $.each($("input[type='checkbox'].checkbox-cpt"),function(index,elem){
                    $(elem).on("click",function(){
                        var tr = $(this).parent().parent();
                        tr.find("input[type='checkbox'].checkbox-delete").remove();

                        if(this.checked){
                            $dom = $("<input type='checkbox' class='checkbox-delete'/>");
                            $(this).parent().parent().find("td").eq(8).append($dom);
                        }else{
                            $dom = $("<input type='checkbox' class='checkbox-delete' checked />");
                            $(this).parent().parent().find("td").eq(8).append($dom);
                        }
                    });
                });

            }
            addObserverChangeCheckbox();

            var $proximaCita = $('#id_proxima_cita');
            var nowPicker = new Date();
            var $egElegida = $('#id_eg_elegida');
            $egElegida.on('change', function () {
                $('.fum, .ecografia, .altura-uterina').removeClass('success');
                if (this.value === 'fum') {
                    $('.fum').addClass('success');
                } else if (this.value === 'ecografia') {
                    $('.ecografia').addClass('success');
                } else {
                    $('.altura-uterina').addClass('success');
                }
            }).parents('.form-group').hide();

            $('#js-btn-eg-fum').on('click', function () {
                $egElegida.val('fum').trigger('change');
            });
            $('#js-btn-eg-eco').on('click', function () {
                $egElegida.val('ecografia').trigger('change');
            });
            $('#js-btn-eg-au').on('click', function () {
                $egElegida.val('altura uterina').trigger('change');
            });

            $proximaCita.datepicker({
                onRender: function (date) {
                    return date.valueOf() < nowPicker.valueOf() ? 'disabled' : '';
                }
            });
            var $checkBoxIce = $('.checkbox-cie');
            $('.for-select').on('change', function () {
                if ($(this).is(':checked')) {
                    $('#tbody-seleccionados').append($(this).parents('tr'));
                }
            });
            $('#id_otros_examenes').select2({
                formatNoMatches: function() {
                    return 'Sin resultados';
                },
                width: '350px'
            });
            $proximaCita.on('keydown', function () {
                return false;
            });
            var $tbody = $('#tbody-seleccionados');
            function setOrderValues() {
                $tbody.find('tr').each(function (i, elem) {
                    $(elem).attr('data-order', i + 1);
                });
            }
            $tbody.sortable({
                placeholder: "ui-state-highlight",
                stop: function (event, ui) {
                    setOrderValues();
                }
            });
            $('#input-search').select2({
                placeholder: 'Ingrese el nombre o codigo del cie',
                minimumInputLength: 3,
                ajax: {
                    url: '{% url 'cie:api_search' %}',
                    dataType: 'json',
                    type: 'get',
                    data: function (term, page) {
                        return {
                            q: term
                        };
                    },
                    results: function (data, page) {
                        return {
                            results: data
                        }
                    }
                },
                formatSelection: function (cie) {
                    if ($tbody.html().indexOf(cie.codigo) === -1) {
                        var html = '<tr>\
                                        <td>\
                                            <input type="checkbox" class="checkbox-cie" data-cie="#codigo" checked/>\
                                        </td>\
                                        <td class="col-md-4">#nombre</td>\
                                        <td>#codigo</td>\
                                        <td>\
                                            <label>\
                                                <input type="radio" name="radio-detalle-#rcodigo" value="D"/>\
                                            </label>\
                                        </td>\
                                        <td>\
                                            <label>\
                                                <input type="radio" name="radio-detalle-#rcodigo" value="P"/>\
                                            </label>\
                                        </td>\
                                        <td>\
                                            <label>\
                                                <input type="radio" name="radio-detalle-#rcodigo" value="R"/>\
                                            </label>\
                                        </td>\
                                        <td>\
                                            <input type="text" class="form-control laboratorio"/>\
                                        </td>\
                                        <td>\
                                            <textarea class="form-control observacion" rows="1"></textarea>\
                                        </td>\
                                        <td>\
                                            <input type="checkbox" class="checkbox-delete"/>\
                                        </td>\
                                    </tr>';
                        var compiled = html.replace(/#codigo/g, cie.codigo.toString()).replace(/#nombre/g, cie.nombre).replace(/#rcodigo/g, cie.codigo.toString().replace(".","-"));
                        $tbody.append(compiled);
                    }
                    return this.placeholder;
                },
                formatResult: function (cie) {
                    return '<p>' + cie.nombre + '</p>';
                },
                formatNoMatches: function (term) {
                    return 'No se encontraron resultados';
                }
            }).on("change", function(e) {
                addObserverChangeCheckbox();
            });
            //Javascript para buscar procedimientos medicos
             var $tbodycpt = $('#tbody-seleccionados-cpt');
            $('#input-search-cpt').select2({
                placeholder: 'Ingrese el nombre o codigo del cpt',
                minimumInputLength: 3,
                ajax: {
                    url: '{% url 'cpt:api_search' %}',
                    dataType: 'json',
                    type: 'get',
                    data: function (term, page) {
                        return {
                            q: term
                        };
                    },
                    results: function (data, page) {
                        return {
                            results: data
                        }
                    }
                },
                formatSelection: function (cpt) {
                    if ($tbodycpt.html().indexOf(cpt.codigo) === -1) {
                        var html = '<tr>\
                                        <td>\
                                            <input type="checkbox" class="checkbox-cpt" data-cpt="#codigo" checked/>\
                                        </td>\
                                        <td class="col-md-4">#nombre</td>\
                                        <td>#codigo</td>\
                                        <td>\
                                            <textarea class="form-control observacion" rows="1"></textarea>\
                                        </td>\
                                        <td>\
                                            <input type="checkbox" class="checkbox-delete"/>\
                                        </td>\
                                    </tr>';
                        var compiled = html.replace(/#codigo/g, cpt.codigo.toString()).replace(/#nombre/g, cpt.nombre).replace(/#rcodigo/g, cpt.codigo.toString().replace(".","-"));
                        $tbodycpt.append(compiled);
                    }
                    return this.placeholder;
                },
                formatResult: function (cpt) {
                    return '<p>' + cpt.nombre + '</p>';
                },
                formatNoMatches: function (term) {
                    return 'No se encontraron resultados';
                }
            }).on("change", function(e) {
                addObserverChangeCheckbox();
            });

            //fin

            var sprintf = function(str) {
                var args = arguments,
                flag = true,
                i = 1;

                str = str.replace(/%s/g, function() {
                var arg = args[i++];

                if (typeof arg === 'undefined') {
                flag = false;
                return '';
                }
                return arg;
                });
                return flag ? str : '';
            };

            $('#btn-save').on('click', function (event) {
                event.preventDefault();

                var request_ajax = {"cie":[] , "cpt":[]};

                $('.checkbox-cie:checked').each(function (checkbox) {
                    var $tr = $(this).parents('tr');
                    var codigo = "" + $(this).data('cie') + "";
                    var namecontrol = 'radio-detalle-' + codigo.replace(".","-");
                    var searchdom = sprintf('input[type=radio][name=%s]:checked',namecontrol);
                    request_ajax["cie"].push({
                        codigo: codigo,
                        tipo: $tr.find(searchdom).val(),
                        laboratorio: $tr.find('.laboratorio').val(),
                        observacion: $tr.find('.observacion').val(),
                        order: $tr.data('order'),
                        delete: $(this).parents('tr').find('.checkbox-delete').is(':checked')
                    });
                });

                $('.checkbox-cpt:checked').each(function (checkbox) {
                    var $tr = $(this).parents('tr');
                    var codigo = "" + $(this).data('cpt') + "";
                    request_ajax["cpt"].push({
                        codigo: codigo,
                        observacion: $tr.find('.observacion').val(),
                        order: $tr.data('order'),
                        delete: $(this).parents('tr').find('.checkbox-delete').is(':checked')
                    });
                });

                var messages = [];
                request_ajax["cie"].forEach(function (detalle) {
                    if (detalle.tipo === undefined) {
                        messages.push('CIE: ' + detalle.codigo + ' debe seleccionar un tipo de diagnostico');
                    }
                });

                if (messages.length) {
                    alert(messages.join('\n'));
                } else {
                    if (!request_ajax["cie"].length) {
                        alert('Debe elegir al menos un diagnostico para continuar');
                    }else {
                        $.ajax({
                            method: 'post',
                            url: '{% url 'controles:diagnostico' control.id %}',
                            contentType: 'application/json',
                            data: JSON.stringify(request_ajax),
                            dataType: 'json',
                            success: function (data) {
                                if (data.status === 'success') {
                                    $('form').submit();
                                } else {
                                    alert('Ocurrio un problema intente nuevamente');
                                }
                            }
                        });
                    }
                }
            });
            // Charts
            d3.json('{% url 'controles:data_ganancia_peso_materno' control.id %}', function(data) {
                nv.addGraph(function() {
                    var chart = nv.models.lineChart().
                        margin({left: 100}).
                        useInteractiveGuideline(true).
                        transitionDuration(350).
                        showLegend(true).
                        showYAxis(true).
                        showXAxis(true).
                        color(d3.scale.category10().range()).
                        height(400).
                        x(function (d) {return d[0]}).
                        y(function (d) {return d[1]});
                    chart.xAxis.axisLabel('Semanas');
                    chart.yAxis.axisLabel('Peso (kg)');
                    d3.select('#chart-ganancia-peso-materno svg').datum(data).call(chart);
                    nv.utils.windowResize(function() { chart.update() });
                    return chart;
                });
            });
            d3.json('{% url 'controles:data_altura_uterina' control.id %}', function(data) {
                nv.addGraph(function() {
                    var chart = nv.models.lineChart().
                        margin({left: 100}).
                        useInteractiveGuideline(true).
                        transitionDuration(350).
                        showLegend(true).
                        showYAxis(true).
                        showXAxis(true).
                        color(d3.scale.category10().range()).
                        height(400).
                        x(function (d) {return d[0]}).
                        y(function (d) {return d[1]});
                    chart.xAxis.axisLabel('Semanas');
                    chart.yAxis.axisLabel('Altura uterina (cm)');
                    d3.select('#chart-altura-uterina svg').datum(data).call(chart);
                    nv.utils.windowResize(function() { chart.update() });
                    return chart;
                });
            });
            makeChart('{% url 'paciente:antecedentes_resume_json' paciente.id %}', 'antecedentes-obstetricos-div');
            {% if 'controles.change_diagnostico' not in user.get_all_permissions %}
            $('input, select, textarea').prop('disabled', true);
            {% endif %}


            $('.btn-save-before').on('click', function (event) {
                event.preventDefault();
                $('#next-url').val($(this).data('next-url'));
                $('#form-diagnostico').submit();
            });

        });
    </script>
{% endblock %}
